<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lançamentos — Controle Financeiro</title>
<link rel="stylesheet" href="assets/css/styles.css">
<script defer src="assets/js/app.js"></script>
<script defer>
document.addEventListener('DOMContentLoaded', async ()=>{
  await setupNav('lancamentos');
  const form = document.getElementById('lanForm');
  const msg = document.getElementById('msg');

  // Carrega categorias e contas nos selects
  async function carregarSelects(){
    const cats = await api('api/lancamentos.php?mode=categorias');
    const contas = await api('api/lancamentos.php?mode=contas');
    const sc = document.getElementById('categoria_id');
    const sct = document.getElementById('conta_id');
    sc.innerHTML = '<option value="">Categoria (opcional)</option>' + cats.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
    sct.innerHTML = '<option value="">Conta (opcional)</option>' + contas.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
  }

  // Carrega lista de lançamentos
  async function carregarLista(){
    const lista = await api('api/lancamentos.php');
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = (lista && lista.length) ? lista.map(l=>`
      <tr>
        <td>${new Date(l.data).toLocaleDateString('pt-BR')}</td>
        <td>${l.descricao}</td>
        <td>${l.tipo}</td>
        <td class="${l.tipo === 'entrada' ? 'pos' : 'neg'}">
          ${l.tipo === 'saida' ? '- ' : ''}R$ ${Number(l.valor).toFixed(2).replace('.',',')}
        </td>
        <td>${l.categoria_nome || '-'}</td>
        <td>${l.conta_nome || '-'}</td>
      </tr>
    `).join('') : '<tr><td colspan="6">Sem lançamentos.</td></tr>';
  }

  // Envio do formulário
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = '';
    const body = {
      descricao: form.descricao.value.trim(),
      valor: parseFloat(form.valor.value),
      data: form.data.value,
      tipo: form.tipo.value,
      categoria_id: form.categoria_id.value || null,
      conta_id: form.conta_id.value || null
    };
    try {
      const r = await api('api/lancamentos.php', { method:'POST', body: JSON.stringify(body) });
      if (r && r.success) {
        form.reset();
        form.data.value = new Date().toISOString().slice(0,10);
        await carregarLista();
        msg.textContent = 'Lançamento adicionado!';
      } else {
        msg.textContent = (r && r.error) || 'Erro ao adicionar.';
      }
    } catch (err) {
      msg.textContent = err.message;
    }
  });

  await carregarSelects();
  await carregarLista();
  form.data.value = new Date().toISOString().slice(0,10);
});
</script>
</head>
<body>
<div id="nav"></div>
<main class="container">
  <h2>Lançamentos</h2>
  <div id="msg" class="alert" style="display:block"></div>
  <div class="card">
    <form id="lanForm">
      <div class="row">
        <input type="text" name="descricao" placeholder="Descrição" required>
        <input type="number" step="0.01" name="valor" placeholder="Valor" required>
        <input type="date" name="data" required>
      </div>
      <div class="row">
        <select name="tipo" required>
          <option value="entrada">Entrada</option>
          <option value="saida">Saída</option>
        </select>
        <select name="categoria_id" id="categoria_id"></select>
        <select name="conta_id" id="conta_id"></select>
      </div>
      <div class="row full">
        <button type="submit">Adicionar lançamento</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h3>Últimos lançamentos</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Descrição</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th>Categoria</th>
          <th>Conta</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>
</body>
</html>